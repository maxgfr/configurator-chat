<!DOCTYPE html>
<html>

<head>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<meta charset="UTF-8">
	<title>PSA Chatbot</title>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">

	<link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Open+Sans'>
	<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.min.css'>

	<link rel="stylesheet" href="stylesheets/style.css">

</head>

<body>

	<div class="chat">
		<div class="chat-title">
			<h1>LYDDY</h1>
			<h2>PSA Chatbot</h2>
			<figure class="avatar">
				<img src="images/bot.png" /></figure>
			</div>
			<div class="messages">
				<div class="messages-content">
				</div>
			</div>
			<div class="message-box">
				<textarea type="text" class="message-input" placeholder="Type message..."></textarea>
				<button type="submit" class="message-submit">Send</button>
			</div>

	</div>
	<div class="bg"></div>
	<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js'></script>


	<script>

		var $messages = $('.messages-content'),
		d, h, m,
		i = 0;
		$(document).ready(function() {
			$messages.mCustomScrollbar();
			setTimeout(function() {
				$.ajax({
					type: "POST",
					url: "/",
					data: {input: ""},
					dataType: 'json',
					success: function (res) {
						if ($('.message-input').val() != '') {
							return false;
						}
						$('<div class="message loading new"><figure class="avatar"><img src="images/bot.png" /></figure><span></span></div>').appendTo($('.mCSB_container'));
						updateScrollbar();

						setTimeout(function() {
							$('.message.loading').remove();
							$('<div class="message new"><figure class="avatar"><img src="images/bot.png" /></figure>' + res + '</div>').appendTo($('.mCSB_container')).addClass('new');
							setDate();
							updateScrollbar();
							i++;
						}, 1000 + (Math.random() * 20) * 100);
					},
					error: function (data) {
						console.log('Error:', data);
					}
				});
			}, 100);

		});

		function updateScrollbar() {
			$messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
				scrollInertia: 10,
				timeout: 0
			});
		}

		function setDate() {
			d = new Date()
			if (m != d.getMinutes()) {
				m = d.getMinutes();
				$('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
			}
		}

		function insertMessage(msg,message) {

			if ($.trim(msg) == '') {
				return false;
			}
			$('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
			setDate();
			$('.message-input').val(null);
			updateScrollbar();
			setTimeout(function() {
				if ($('.message-input').val() != '') {
					return false;
				}
				$('<div class="message loading new"><figure class="avatar"><img src="images/bot.png" /></figure><span></span></div>').appendTo($('.mCSB_container'));
				updateScrollbar();

				setTimeout(function() {
					$('.message.loading').remove();
					$('<div class="message new"><figure class="avatar"><img src="images/bot.png" /></figure>' + message + '</div>').appendTo($('.mCSB_container')).addClass('new');
					setDate();
					updateScrollbar();
					i++;
				}, 1000 + (Math.random() * 20) * 100);
			}, 1000 + (Math.random() * 20) * 100);
		}

		$('.message-submit').click(function() {
			msg = $('.message-input').val();
			$.ajax({
				type: "POST",
				url: "/",
				data: {input: msg},
				dataType: 'json',
				success: function (res) {
					console.log(res);
					insertMessage(msg,res)
				},
				error: function (data) {
					console.log('Error:', data);
				}
			});
		});

		$(window).on('keydown', function(e) {
			if (e.which == 13) {
				msg = $('.message-input').val();
				$.ajax({
					type: "POST",
					url: "/",
					data: {input: msg},
					dataType: 'json',
					success: function (res) {
						console.log(res);
						insertMessage(msg,res)
					},
					error: function (data) {
						console.log('Error:', data);
					}
				});
				return false;
			}
		})

	</script>



</body>

</html>
